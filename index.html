<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ó–º–µ–π–∫–∞ - Telegram Mini App</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 400px;
            max-height: 400px;
            margin: auto;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s;
        }

        #start-screen, #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            border-radius: 10px;
        }

        #start-screen.visible, #game-over-screen.visible {
            opacity: 1;
            pointer-events: auto;
        }

        h1, h2 {
            margin: 10px 0;
            font-size: 24px;
            text-align: center;
        }

        p {
            margin: 5px 0;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            margin: 10px 0;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        button:active {
            transform: scale(0.98);
        }

        #sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            background: none;
            border: none;
            cursor: pointer;
        }

        #infinite-walls-toggle {
            margin: 10px 0;
            display: flex;
            align-items: center;
        }

        #infinite-walls-toggle input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div id="start-screen" class="visible">
            <h1>–ó–º–µ–π–∫–∞</h1>
            <p>–õ—É—á—à–∏–π —Å—á—ë—Ç: <span id="best-score">0</span></p>
            <div id="infinite-walls-toggle">
                <input type="checkbox" id="infinite-walls" checked>
                <label for="infinite-walls">–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Å—Ç–µ–Ω—ã</label>
            </div>
            <button id="start-button">–°—Ç–∞—Ä—Ç</button>
        </div>
        <div id="game-over-screen">
            <h2>Game Over</h2>
            <p>–°—á—ë—Ç: <span id="final-score">0</span></p>
            <p>–õ—É—á—à–∏–π —Å—á—ë—Ç: <span id="best-score-go">0</span></p>
        </div>
        <button id="sound-toggle">üîä</button>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const webApp = window.Telegram.WebApp;
        webApp.ready();
        webApp.expand(); // –†–∞—Å—à–∏—Ä–∏—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–º–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const themeParams = webApp.themeParams;
        const bgColor = themeParams.bg_color || '#f0f0f0';
        const textColor = themeParams.text_color || '#222222';
        const buttonColor = themeParams.button_color || '#40a7e3';
        const buttonTextColor = themeParams.button_text_color || '#ffffff';
        const secondaryBgColor = themeParams.secondary_bg_color || '#ffffff';
        const snakeColor = buttonColor;
        const appleColor = '#ed4956';

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã
        document.body.style.backgroundColor = bgColor;
        document.body.style.color = textColor;
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.style.backgroundColor = buttonColor;
            btn.style.color = buttonTextColor;
        });
        const screens = document.querySelectorAll('#start-screen, #game-over-screen');
        screens.forEach(screen => {
            screen.style.backgroundColor = `rgba(${parseInt(secondaryBgColor.slice(1,3),16)}, ${parseInt(secondaryBgColor.slice(3,5),16)}, ${parseInt(secondaryBgColor.slice(5,7),16)}, 0.8)`;
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∞
        webApp.onEvent('viewportChanged', () => {
            webApp.expand();
        });

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Main Button
        webApp.MainButton.hide();
        webApp.MainButton.setText('–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞');
        webApp.MainButton.color = buttonColor;
        webApp.MainButton.textColor = buttonTextColor;

        // –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        let cols, rows;

        function resizeCanvas() {
            const size = Math.min(window.innerWidth, window.innerHeight) * 0.9;
            canvas.width = Math.floor(size / gridSize) * gridSize;
            canvas.height = canvas.width; // –ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ –ø–æ–ª–µ
            cols = canvas.width / gridSize;
            rows = canvas.height / gridSize;
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        let snake = [{ x: 5, y: 5 }];
        let direction = { x: 1, y: 0 };
        let apple = { x: 10, y: 10 };
        let score = 0;
        let bestScore = localStorage.getItem('bestScore') || 0;
        document.getElementById('best-score').textContent = bestScore;
        document.getElementById('best-score-go').textContent = bestScore;
        let gameInterval;
        let speed = 150; // –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (ms per frame)
        let soundEnabled = true;
        let infiniteWalls = true;

        const eatSound = new Audio('data:audio/mpeg;base64,/+NIxAAAAAAAAAAAAAAA/+NIxAAAAANIAAAD/UNT...'); // –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ base64 –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –∑–≤—É–∫–∞ (–∏–ª–∏ —Å—Å—ã–ª–∫—É, –Ω–æ –¥–ª—è –º–∏–Ω–∏-app –ª—É—á—à–µ base64)
        const gameOverSound = new Audio('data:audio/mpeg;base64,/+NIxAAAAAAAAAAAAAAA/+NIxAAAAANIAAAD/UNT...'); // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ

        document.getElementById('sound-toggle').addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-toggle').textContent = soundEnabled ? 'üîä' : 'üîá';
        });

        document.getElementById('infinite-walls').addEventListener('change', (e) => {
            infiniteWalls = e.target.checked;
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case 'ArrowUp': if (direction.y !== 1) direction = { x: 0, y: -1 }; break;
                case 'ArrowDown': if (direction.y !== -1) direction = { x: 0, y: 1 }; break;
                case 'ArrowLeft': if (direction.x !== 1) direction = { x: -1, y: 0 }; break;
                case 'ArrowRight': if (direction.x !== -1) direction = { x: 1, y: 0 }; break;
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–∞–π–ø–∞–º–∏
        let touchStartX = 0;
        let touchStartY = 0;
        canvas.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touchEndX = e.touches[0].clientX;
            const touchEndY = e.touches[0].clientY;
            const dx = touchEndX - touchStartX;
            const dy = touchEndY - touchStartY;

            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > 0 && direction.x !== -1) direction = { x: 1, y: 0 };
                else if (dx < 0 && direction.x !== 1) direction = { x: -1, y: 0 };
            } else {
                if (dy > 0 && direction.y !== -1) direction = { x: 0, y: 1 };
                else if (dy < 0 && direction.y !== 1) direction = { x: 0, y: -1 };
            }
        });

        function generateApple() {
            apple.x = Math.floor(Math.random() * cols);
            apple.y = Math.floor(Math.random() * rows);
        }

        function draw() {
            // –§–æ–Ω
            ctx.fillStyle = secondaryBgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –ó–º–µ–π–∫–∞
            ctx.fillStyle = snakeColor;
            snake.forEach(part => {
                ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize - 1, gridSize - 1);
            });

            // –Ø–±–ª–æ–∫–æ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            ctx.fillStyle = appleColor;
            ctx.beginPath();
            ctx.arc(apple.x * gridSize + gridSize / 2, apple.y * gridSize + gridSize / 2, gridSize / 2 - 1, 0, 2 * Math.PI);
            ctx.fill();

            // –°—á—ë—Ç
            ctx.fillStyle = textColor;
            ctx.font = '16px sans-serif';
            ctx.fillText(`–°—á—ë—Ç: ${score}`, 10, 20);
        }

        function update() {
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            // –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ —Å—Ç–µ–Ω—ã
            if (infiniteWalls) {
                if (head.x >= cols) head.x = 0;
                else if (head.x < 0) head.x = cols - 1;
                if (head.y >= rows) head.y = 0;
                else if (head.y < 0) head.y = rows - 1;
            } else {
                if (head.x < 0 || head.x >= cols || head.y < 0 || head.y >= rows) return gameOver();
            }

            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Å–æ–±–æ–π
            if (snake.some(part => part.x === head.x && part.y === head.y)) return gameOver();

            snake.unshift(head);

            // –°—ä–µ–¥–∞–Ω–∏–µ —è–±–ª–æ–∫–∞
            if (head.x === apple.x && head.y === apple.y) {
                score++;
                generateApple();
                if (soundEnabled) eatSound.play();
                // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ (—Å–ª–æ–∂–Ω–æ—Å—Ç—å)
                if (score % 5 === 0) speed = Math.max(50, speed - 10);
                clearInterval(gameInterval);
                gameInterval = setInterval(update, speed);
                // –ú–∏–∫—Ä–æ-–∞–Ω–∏–º–∞—Ü–∏—è: –≤–∏–±—Ä–∞—Ü–∏—è
                if ('vibrate' in navigator) navigator.vibrate(100);
            } else {
                snake.pop();
            }

            draw();
        }

        function startGame() {
            snake = [{ x: 5, y: 5 }];
            direction = { x: 1, y: 0 };
            score = 0;
            speed = 150;
            generateApple();
            document.getElementById('start-screen').classList.remove('visible');
            clearInterval(gameInterval);
            gameInterval = setInterval(update, speed);
            webApp.MainButton.hide();
        }

        function gameOver() {
            clearInterval(gameInterval);
            if (soundEnabled) gameOverSound.play();
            if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
            document.getElementById('final-score').textContent = score;
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('bestScore', bestScore);
                document.getElementById('best-score-go').textContent = bestScore;
                document.getElementById('best-score').textContent = bestScore;
            }
            document.getElementById('game-over-screen').classList.add('visible');
            webApp.MainButton.show();
            webApp.MainButton.onClick(() => {
                document.getElementById('game-over-screen').classList.remove('visible');
                document.getElementById('start-screen').classList.add('visible');
                webApp.MainButton.hide();
            });
        }

        document.getElementById('start-button').addEventListener('click', startGame);

        // –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø–æ–¥–µ–ª–∏—Ç—å—Å—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        // webApp.showShareUrlButton({ url: 'https://t.me/...', text: `–ú–æ–π —Å—á—ë—Ç –≤ –ó–º–µ–π–∫–µ: ${score}!` });

        // –ó–≤—É–∫–∏: –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ base64 –∏–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∑–≤—É–∫–∏. –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –æ–ø—É—â–µ–Ω–æ.
    </script>
</body>
</html>
